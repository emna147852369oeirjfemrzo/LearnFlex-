{% extends 'base.html.twig' %}

{% block title %}Ajouter un événement - LearnFlex+{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css/styles.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/dashboard.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block body %}
<div class="event-edit-wrapper">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="{{ asset('assets/images/logo1.png') }}" alt="LearnFlex+ Logo" class="nav-logo">
                <span>LearnFlex</span><span class="highlight">+</span>
            </div>
            <button class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                    <li><a href="#"><i class="fas fa-users"></i><span>Utilisateurs</span></a></li>
                    <li><a href="#"><i class="fas fa-book-open"></i><span>Contenu pédagogique</span></a></li>
                    <li><a href="#"><i class="fas fa-graduation-cap"></i><span>Evaluation</span></a></li>
                    <li><a href="#"><i class="fas fa-question-circle"></i><span>Questionnaire</span></a></li>
                    <li><a href="#"><i class="fas fa-directions"></i><span>Orientation</span></a></li>
                    <li><a href="{{ path('app_organisme_index') }}"><i class="fas fa-building"></i><span>Organisme</span></a></li>
                    <li class="active"><a href="{{ path('app_evenement_index') }}"><i class="fas fa-calendar-alt"></i><span>Événement</span></a></li>
                    <li><a href="#"><i class="fas fa-comments"></i><span>Forum</span></a></li>
                </ul>
            </nav>
        </div>
        <div class="sidebar-footer">
            <a href="#" class="user-profile">
                <img src="{{ asset('assets/images/placeholder-admin.png') }}" alt="Admin" class="user-img">
                <div class="user-info">
                    <h4>Admin User</h4>
                    <p>Administrateur</p>
                </div>
            </a>
            <a href="#" class="logout"><i class="fas fa-sign-out-alt"></i><span>Déconnexion</span></a>
        </div>
    </aside>

    <main class="event-edit-main">
        <div class="event-edit-container">
            <a href="{{ path('app_evenement_index') }}" class="event-edit-back">
                <i class="fas fa-arrow-left"></i> Retour à la liste
            </a>

            <div class="event-edit-header">
                <span class="event-edit-badge"><i class="fas fa-plus"></i> Nouveau</span>
                <h1>Ajouter un événement</h1>
                <p class="event-edit-subtitle">Remplissez les informations ci-dessous pour créer un nouvel événement</p>
            </div>

            {{ form_start(form, {'attr': {'class': 'event-edit-form'}}) }}

            <!-- Informations générales -->
            <div class="form-card">
                <h3 class="form-section-title"><i class="fas fa-info-circle"></i> Informations générales</h3>
                <div class="form-grid">
                    {{ form_row(form.titre, {'row_attr': {'class': 'form-field'}}) }}
                    {{ form_row(form.organisme, {'row_attr': {'class': 'form-field'}}) }}
                    <div class="form-field form-field-full">
                        {{ form_label(form.description) }}
                        <div class="description-ai-wrapper" style="position: relative;">
                            {{ form_widget(form.description) }}
                            <button type="button" id="btn-generate-ai" class="btn-ai-gen" title="Générer avec l'IA">
                                <i class="fas fa-robot"></i> Générer avec l'IA
                            </button>
                        </div>
                        {{ form_errors(form.description) }}
                        <div id="ai-loading" style="display: none; font-size: 0.85rem; color: #0d6efd; margin-top: 5px;">
                            <i class="fas fa-spinner fa-spin"></i> Génération en cours...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dates -->
            <div class="form-card">
                <h3 class="form-section-title"><i class="fas fa-calendar-alt"></i> Dates et horaires</h3>
                <div class="form-grid">
                    {{ form_row(form.datedebut, {'row_attr': {'class': 'form-field'}}) }}
                    {{ form_row(form.datefin, {'row_attr': {'class': 'form-field'}}) }}
                </div>
            </div>

            <!-- Lieu et mode -->
            <div class="form-card">
                <h3 class="form-section-title"><i class="fas fa-map-marker-alt"></i> Lieu et modalités</h3>
                <div class="form-grid">
                    {{ form_row(form.lieu, {'row_attr': {'class': 'form-field'}}) }}
                    {{ form_row(form.mode, {'row_attr': {'class': 'form-field'}}) }}
                    {{ form_row(form.capacitemax, {'row_attr': {'class': 'form-field'}}) }}
                </div>
            </div>

            <!-- Public et inscriptions -->
            <div class="form-card">
                <h3 class="form-section-title"><i class="fas fa-users"></i> Public et inscriptions</h3>
                <div class="form-grid">
                    {{ form_row(form.publiccible, {'row_attr': {'class': 'form-field form-field-full'}}) }}
                    {{ form_row(form.lieninscription, {'row_attr': {'class': 'form-field form-field-full'}}) }}
                </div>
            </div>

            <!-- Contact -->
            <div class="form-card">
                <h3 class="form-section-title"><i class="fas fa-address-card"></i> Contact</h3>
                <div class="form-grid">
                    {{ form_row(form.contactemail, {'row_attr': {'class': 'form-field'}}) }}
                    {{ form_row(form.contacttelephone, {'row_attr': {'class': 'form-field'}}) }}
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                {{ form_widget(form.save, {'attr': {'class': 'btn-save'}}) }}
                <a href="{{ path('app_evenement_index') }}" class="btn-cancel">Annuler</a>
            </div>

            {{ form_end(form) }}
        </div>
    </main>
</div>

<style>
/* Style général compatible avec les champs de ton entité Evenement */
.event-edit-wrapper { display:flex; min-height:100vh; font-family:'Inter', sans-serif; background:#f8f9fa; }
.event-edit-main { flex:1; padding:32px; overflow-x:hidden; }
.event-edit-container { max-width:900px; margin:0 auto; }
.event-edit-back { display:inline-flex; align-items:center; gap:8px; color:#0d6efd; font-weight:600; text-decoration:none; margin-bottom:24px; font-size:0.95rem; transition:color 0.2s; }
.event-edit-back:hover { color:#0a58ca; }
.event-edit-header { margin-bottom:32px; }
.event-edit-badge { display:inline-block; background:#e8f4fd; color:#0d6efd; padding:6px 14px; border-radius:20px; font-size:0.85rem; font-weight:600; margin-bottom:12px; }
.form-card { background:#fff; border-radius:16px; padding:28px; margin-bottom:24px; box-shadow:0 2px 12px rgba(0,0,0,0.06); }
.form-section-title { font-size:1.1rem; font-weight:600; color:#1a1a2e; margin:0 0 20px; display:flex; align-items:center; gap:10px; }
.form-section-title i { color:#0d6efd; }
.form-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.form-field-full { grid-column:1 / -1; }
.event-edit-form .form-field label { display:block; font-weight:600; color:#1a1a2e; margin-bottom:8px; font-size:0.9rem; }
.event-edit-form .form-field input, .event-edit-form .form-field select, .event-edit-form .form-field textarea { width:100%; padding:12px 16px; border:2px solid #e9ecef; border-radius:10px; font-size:0.95rem; color:#1a1a2e; background:#f8f9fa; transition:all 0.2s; box-sizing:border-box; }
.event-edit-form .form-field input:focus, .event-edit-form .form-field select:focus, .event-edit-form .form-field textarea:focus { outline:none; border-color:#0d6efd; background:#fff; }
.event-edit-form .form-field textarea { min-height:100px; resize:vertical; }
.form-actions { display:flex; gap:16px; margin-top:8px; flex-wrap:wrap; }
.btn-save, .event-edit-form button[type="submit"] { padding:14px 28px; background:#0d6efd; color:#fff !important; border:none; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer; transition:all 0.2s; }
.btn-save:hover, .event-edit-form button[type="submit"]:hover { background:#0a58ca; }
.btn-cancel { padding:14px 28px; background:#fff; color:#5a5a72; border:2px solid #e9ecef; border-radius:10px; font-size:1rem; font-weight:600; text-decoration:none; transition:all 0.2s; }
.btn-cancel:hover { border-color:#0d6efd; color:#0d6efd; }
@media (max-width:768px) { .form-grid { grid-template-columns:1fr; } .form-field-full { grid-column:1; } }
.btn-ai-gen { position:absolute; right:10px; bottom:10px; background:#e8f4fd; color:#0d6efd; border:1px solid #0d6efd; padding:6px 12px; border-radius:8px; font-size:0.8rem; font-weight:600; cursor:pointer; transition:all 0.2s; z-index:5; }
.btn-ai-gen:hover { background:#0d6efd; color:#fff; }
.btn-ai-gen:disabled { opacity:0.6; cursor:wait; }
</style>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
(function() {
    function initAiGeneration() {
        const btnAi = document.getElementById('btn-generate-ai');
        const descriptionField = document.getElementById('evenement_description');
        const titleField = document.getElementById('evenement_titre');
        const loadingDiv = document.getElementById('ai-loading');

        if (!btnAi || !descriptionField) return;

        // Prevent duplicate listeners
        if (btnAi.getAttribute('data-ai-initialized')) return;
        btnAi.setAttribute('data-ai-initialized', 'true');

        btnAi.addEventListener('click', async function(e) {
            e.preventDefault();
            const topic = descriptionField.value.trim() || (titleField ? titleField.value.trim() : '');
            
            if (!topic) {
                alert('Veuillez saisir au moins quelques mots.');
                return;
            }

            btnAi.disabled = true;
            loadingDiv.style.display = 'block';

            try {
                const response = await fetch('{{ path("app_evenement_generate_ai") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic })
                });

                const data = await response.json();
                if (data.content) {
                    descriptionField.value = data.content;
                } else {
                    alert('Erreur: ' + (data.error || 'Pas de contenu'));
                }
            } catch (error) {
                alert('Erreur réseau/IA');
            } finally {
                btnAi.disabled = false;
                loadingDiv.style.display = 'none';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initAiGeneration);
    document.addEventListener('turbo:load', initAiGeneration);
})();
</script>
{% endblock %}
