<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport ‚Äî {{ examen.titre }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DejaVu Sans', sans-serif; color: #1f4f65; font-size: 13px; }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #1f4f65, #4DB6AC);
            color: white;
            padding: 30px 40px;
            border-radius: 0 0 20px 20px;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .logo-text { font-size: 24px; font-weight: bold; letter-spacing: 1px; }
        .logo-text span { color: #4DB6AC; }
        .header-date { font-size: 12px; opacity: 0.85; }

        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
        .header p  { opacity: 0.85; font-size: 14px; }

        /* ===== BADGES NIVEAU ===== */
        .badge {
            display: inline-block;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .badge-facile   { background: #d1fae5; color: #065f46; }
        .badge-moyen    { background: #fef3c7; color: #92400e; }
        .badge-difficile { background: #fee2e2; color: #991b1b; }

        /* ===== SECTIONS ===== */
        .section {
            margin: 25px 30px;
            background: #fff;
            border-radius: 14px;
            padding: 20px 25px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f4f65;
            border-bottom: 2px solid #4DB6AC;
            padding-bottom: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title .icon { color: #4DB6AC; }

        /* ===== STATS BOXES ===== */
        .stats-grid {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
        }
        .stat-box {
            flex: 1;
            min-width: 100px;
            background: #f0f9ff;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid #bae6fd;
        }
        .stat-box .val { font-size: 24px; font-weight: 700; color: #1f4f65; }
        .stat-box .lbl { font-size: 11px; color: #6b7280; margin-top: 4px; }

        /* ===== TABLE ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        thead tr { background: #1f4f65; color: white; }
        thead th { padding: 10px 12px; text-align: left; }
        tbody tr:nth-child(even) { background: #f8fafc; }
        tbody tr:nth-child(odd)  { background: #ffffff; }
        tbody td { padding: 9px 12px; border-bottom: 1px solid #e5e7eb; }

        /* ===== INFRACTIONS ===== */
        .infraction-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .infraction-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .tab_switch { background: #fef3c7; color: #92400e; }
        .copy       { background: #fee2e2; color: #991b1b; }
        .paste      { background: #fce7f3; color: #9d174d; }
        .cut        { background: #ede9fe; color: #5b21b6; }

        /* ===== COMMENTAIRES ===== */
        .comment-box {
            background: #f8fafc;
            border-left: 3px solid #4DB6AC;
            border-radius: 0 10px 10px 0;
            padding: 10px 14px;
            margin-bottom: 10px;
        }
        .comment-box strong { color: #1f4f65; font-size: 12px; }
        .comment-box p      { margin-top: 4px; color: #374151; font-size: 12px; }

        /* ===== FOOTER ===== */
        .footer {
            margin: 20px 30px 10px;
            text-align: center;
            font-size: 11px;
            color: #9ca3af;
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
        }

        /* ===== ETAT ===== */
        .etat-badge {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .planifie  { background: #dbeafe; color: #1e40af; }
        .actif     { background: #d1fae5; color: #065f46; }
        .termine   { background: #f3f4f6; color: #374151; }
        .annule    { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

{# ===== HEADER ===== #}
<div class="header">
    <div class="header-top">
        <div style="display:flex; align-items:center; gap:12px;">
            {% if logoBase64 %}
                <img src="data:image/png;base64,{{ logoBase64 }}" 
                     style="height:45px; width:auto;" alt="Logo">
            {% endif %}
            <div class="logo-text">LearnFlex<span>+</span></div>
        </div>
        <div class="header-date">G√©n√©r√© le {{ dateGeneration|date('d/m/Y √† H:i') }}</div>
    </div>
    <span class="badge badge-{{ examen.niveauexamen }}">{{ examen.niveauexamen }}</span>
    <h1>{{ examen.titre }}</h1>
    <p>{{ examen.description }}</p>
</div>

{# ===== INFOS G√âN√âRALES ===== #}
<div class="section">
    <div class="section-title">
        <span class="icon">üìã</span> Informations g√©n√©rales
    </div>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="val">{{ examen.matiere }}</div>
            <div class="lbl">Mati√®re</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ examen.duree }} min</div>
            <div class="lbl">Dur√©e</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ examen.nbquestion }}</div>
            <div class="lbl">Questions</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ examen.scoretotal }}</div>
            <div class="lbl">Score total</div>
        </div>
        <div class="stat-box">
            <div class="val">{{ examen.coefficient }}</div>
            <div class="lbl">Coefficient</div>
        </div>
        <div class="stat-box">
            <div class="val">
                <span class="etat-badge {{ examen.etat|lower }}">{{ examen.etat }}</span>
            </div>
            <div class="lbl">√âtat</div>
        </div>
    </div>

    <table style="margin-top: 16px;">
        <tr>
            <td><strong>Type</strong></td>
            <td>{{ examen.typeexamen }}</td>
            <td><strong>Date d√©but</strong></td>
            <td>{{ examen.datedebut ? examen.datedebut|date('d/m/Y') : '-' }}</td>
            <td><strong>Date fin</strong></td>
            <td>{{ examen.datefin ? examen.datefin|date('d/m/Y') : '-' }}</td>
        </tr>
    </table>
</div>

{# ===== R√âSULTATS √âTUDIANTS ===== #}
<div class="section">
    <div class="section-title">
        <span class="icon">üë®‚Äçüéì</span> Participation des √©tudiants
    </div>
    {% if statsEtudiants is empty %}
        <p style="color:#6b7280; font-style:italic;">Aucune r√©ponse soumise pour cet examen.</p>
    {% else %}
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>√âtudiant</th>
                    <th>Nb r√©ponses soumises</th>
                    <th>Derni√®re soumission</th>
                </tr>
            </thead>
            <tbody>
                {% for i, s in statsEtudiants %}
                <tr>
                    <td>{{ i + 1 }}</td>
                    <td>{{ s.nom }}</td>
                    <td>{{ s.nbRep }}</td>
                    <td>{{ s.derniere ? s.derniere|date('d/m/Y H:i') : '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>

{# ===== ANTI-TRICHE ===== #}
<div class="section">
    <div class="section-title">
        <span class="icon">üö®</span> Rapport anti-triche
    </div>
    {% if infractionsParType is empty %}
        <p style="color:#065f46; font-style:italic;">‚úÖ Aucune infraction d√©tect√©e.</p>
    {% else %}
        <table style="margin-bottom:16px;">
            <thead>
                <tr>
                    <th>Type d'infraction</th>
                    <th>Nombre</th>
                </tr>
            </thead>
            <tbody>
                {% for type, nb in infractionsParType %}
                <tr>
                    <td><span class="infraction-badge {{ type }}">{{ type|replace({'_': ' '})|upper }}</span></td>
                    <td><strong>{{ nb }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <table>
            <thead>
                <tr>
                    <th>√âtudiant</th>
                    <th>Type</th>
                    <th>Infraction n¬∞</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for log in cheatLogs %}
                <tr>
                    <td>{{ log.etudiant ? log.etudiant.nom : 'Anonyme' }}</td>
                    <td><span class="infraction-badge {{ log.type }}">{{ log.type|replace({'_': ' '})|upper }}</span></td>
                    <td>{{ log.count }}</td>
                    <td>{{ log.createdAt|date('d/m/Y H:i') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>

{# ===== COMMENTAIRES ===== #}
<div class="section">
    <div class="section-title">
        <span class="icon">üí¨</span> Commentaires ({{ commentaires|length }})
    </div>
    {% if commentaires is empty %}
        <p style="color:#6b7280; font-style:italic;">Aucun commentaire pour cet examen.</p>
    {% else %}
        {% for c in commentaires %}
        <div class="comment-box">
            <strong>{{ c.auteur }}</strong>
            <p>{{ c.contenu }}</p>
        </div>
        {% endfor %}
    {% endif %}
</div>

{# ===== FOOTER ===== #}
<div class="footer">
    LearnFlex+ ‚Äî Rapport g√©n√©r√© automatiquement le {{ dateGeneration|date('d/m/Y √† H:i') }}
    | Examen ID : {{ examen.id }}
</div>

</body>
</html>