{% extends 'front/home.html.twig' %}

{% block title %}{{ challenge.titrec }} | LearnFlex+{% endblock %}

{% block header %}
<header class="landing-header">
    <div class="container">
        <div class="header-left">
            <div class="logo">
                <img src="{{ asset('assets/images/logo1.png') }}" alt="Learnflexplus Logo" class="main-logo">
                <span class="logo-text">LearnFlex +</span>
            </div>
        </div>
        <nav class="main-nav">
            <ul>
                <li class="active"><a href="#">Accueil</a></li>
                <li><a href="#">Contenus p√©dagogiques</a></li>
                <li><a href="{{ path('front_evaluation') }}">Evaluation</a></li>
                <li><a href="#">Questionnaire</a></li>
                <li><a href="#">Orientation</a></li>
                <li><a href="#">Forum</a></li>
            </ul>
        </nav>
        <div class="header-right">
            {% if app.user and app.user.role != 'client' %}
                <a href="#" class="btn btn-outline dashboard-btn">Dashboard</a>
            {% endif %}
            {% if app.user %}
                <a href="#" class="btn btn-primary logout-btn">D√©connexion</a>
            {% else %}
                <a href="#" class="btn btn-primary">Connexion</a>
            {% endif %}
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</header>
{% endblock %}

{% block body %}
<main class="challenge-ui">

    <!-- HERO -->
    <section class="challenge-hero">
        <div class="hero-overlay"></div>
        <div class="container hero-content">
            <span class="hero-badge">üéØ Challenge</span>
            <h1>{{ challenge.titrec }}</h1>
            <p>{{ challenge.descriptionc }}</p>

            <div class="hero-stats">
                <div class="stat-card">
                    <span>Objectif</span>
                    <strong>{{ challenge.objectifscore }}%</strong>
                </div>
                <div class="stat-card">
                    <span>Progression</span>
                    <strong>{{ challenge.progressionactuelle }}%</strong>
                </div>
                <div class="stat-card">
                    <span>Niveau atteint</span>
                    <strong>{{ challenge.niveauatteint }}</strong>
                </div>
                <div class="stat-card">
                    <span>R√©compense</span>
                    <strong>{{ challenge.typerecomponse }}</strong>
                </div>
                <div class="stat-card">
                    <span>Dernier Score</span>
                    <strong id="last-score">{{ challenge.dernierScore ?: '-' }}</strong>
                </div>
                <div class="stat-card">
                    <span>Dernier Niveau</span>
                    <strong id="last-niveau">{{ challenge.dernierNiveau ?: '-' }}</strong>
                </div>
                <div class="stat-card">
                    <span>Derni√®res R√©ponses</span>
                    <strong>{{ challenge.reponses ? challenge.reponses|join(', ') : '-' }}</strong>
                </div>
            </div>
        </div>
    </section>

    <!-- CONTENU -->
    <section class="challenge-content container">
        {% if challenge.question %}
            <div class="content-card">
                <h3>üß† Activit√© interactive</h3>
                <p class="subtitle">Compl√®te ce challenge pour d√©bloquer l'examen associ√©</p>
                <div id="challenge-container"></div>
                <button id="next-btn" style="display:none;">Suivant</button>
            </div>
        {% else %}
            <div class="empty-state">
                <p>Aucune activit√© interactive disponible.</p>
            </div>
        {% endif %}
    </section>

    <div style="text-align:center; margin-top:20px;">
        <a href="{{ path('challenge_train', { id: challenge.id }) }}" class="cta-btn">
            üéØ Entra√Æne-toi
        </a>
    </div>

</main>
{% endblock %}

{% block stylesheets %}
<style>
.challenge-ui { font-family: 'Poppins', sans-serif; background: #f6f8fc; }
.memory-board { display: flex; flex-wrap: wrap; gap: 10px; max-width: 400px; }
.cta-btn {
    position: relative; display: inline-block; padding: 15px 40px;
    font-size: 18px; font-weight: bold; color: #1e90ff;
    background: rgba(255,255,255,0.1); border: 2px solid #1e90ff;
    border-radius: 30px; text-decoration: none; overflow: hidden; transition: all 0.3s ease;
}
.cta-btn::before {
    content: ""; position: absolute; top: 0; left: -100%;
    width: 100%; height: 100%; background: #1e90ff;
    transition: all 0.3s ease; z-index: 0;
}
.cta-btn:hover::before { left: 0; }
.cta-btn:hover { color: #fff; }
.card { width: 80px; height: 120px; perspective: 600px; cursor: pointer; position: relative; }
.card-front, .card-back {
    width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;
    backface-visibility: hidden; border: 1px solid #333; border-radius: 10px;
    font-size: 20px; position: absolute; transition: transform 0.5s;
}
.card-front { background: #1e90ff; color: white; }
.card-back { background: #ffeb3b; color: black; transform: rotateY(180deg); }
.card.flipped .card-front { transform: rotateY(180deg); }
.card.flipped .card-back { transform: rotateY(0deg); }
.puzzle-steps li {
    padding: 15px 20px; margin: 10px 0; background: #f9fbff;
    border: 2px solid #1f4f65; border-radius: 12px; cursor: grab;
    font-weight: 600; transition: background 0.3s, transform 0.2s; user-select: none;
}
.challenge-hero {
    position: relative; padding: 100px 0;
    background: linear-gradient(135deg, #3fa7d6, #1f4f65);
    color: #fff; overflow: hidden;
    border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
}
.hero-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.08); }
.hero-content { position: relative; z-index: 2; text-align: center; }
.hero-badge { background: #97c3a2; padding: 8px 22px; border-radius: 50px; font-weight:700; display:inline-block; margin-bottom:18px; color:#fff; }
.challenge-hero h1 { font-size: 3rem; font-weight: 800; color:#fff; text-shadow:0 3px 8px rgba(0,0,0,0.25); }
.challenge-hero p { max-width: 720px; margin:auto; opacity:0.95; color:#f0f8ff; }
.hero-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:20px; margin-top:45px; }
.stat-card { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius:22px; padding:25px; text-align:center; }
.stat-card span { display:block; font-size:0.85rem; color:#eee; }
.stat-card strong { font-size:1.5rem; font-weight:700; color:#fff; }
.challenge-content { margin-top:-60px; position: relative; z-index:3; }
.content-card { background:#fff; border-radius:26px; padding:40px; box-shadow:0 20px 50px rgba(0,0,0,0.12); }
.content-card h3 { font-weight:700; color:#1f4f65; }
.subtitle { color:#555; margin-bottom:30px; }
.drag-items { display:flex; justify-content:center; gap:15px; margin:20px 0; }
.drag-item { padding:10px 20px; background:#1f4f65; color:#fff; border-radius:10px; cursor:grab; }
.drop-zones { display:flex; justify-content:center; gap:20px; }
.drop-zone { width:150px; height:100px; border:2px dashed #1f4f65; border-radius:15px; display:flex; align-items:center; justify-content:center; font-weight:bold; background:#f9fbff; }
.empty-state { background:#fff; border-radius:20px; padding:40px; text-align:center; color:#777; }
.styled-option { margin:8px 0; }
.styled-option input[type="radio"] { display:none; }
.styled-option label { display:block; padding:10px 15px; border-radius:12px; background:#eef2ff; cursor:pointer; font-weight:600; transition:0.3s; border:2px solid #1f4f65; }
.styled-option input[type="radio"]:checked + label { background:#4CAF50; color:#fff; border-color:#4CAF50; }
.styled-input input, .styled-input textarea { width:100%; padding:10px 15px; border-radius:12px; border:2px solid #1f4f65; font-size:1rem; transition:0.3s; }
.styled-input input:focus, .styled-input textarea:focus { outline:none; border-color:#4CAF50; box-shadow:0 0 8px #4CAF50; }
@keyframes fadeIn { from{opacity:0;transform:scale(.8)} to{opacity:1;transform:scale(1)} }
@keyframes shake { 0%{transform:translateX(0)} 20%{transform:translateX(-5px)} 40%{transform:translateX(5px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} 100%{transform:translateX(0)} }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
.card { transition:transform 0.5s; transform-style:preserve-3d; }
.card.flipped { transform:rotateY(180deg); }
.card-front,.card-back { position:absolute; backface-visibility:hidden; display:flex; align-items:center; justify-content:center; width:100%; height:100%; }
.card-back { transform:rotateY(180deg); }
/* Victory */
.victory-table { width:100%; border-collapse:collapse; color:#fff; }
.victory-table thead tr { background:#1f4f65; text-align:left; }
.victory-table th, .victory-table td { padding:12px 15px; }
.victory-table tbody tr { border-bottom:1px solid rgba(255,255,255,0.08); }
.victory-table tbody tr:hover { background:rgba(255,255,255,0.05); }
.compare-btn { padding:6px 14px; border-radius:8px; border:none; background:#FF9800; color:#fff; cursor:pointer; font-size:0.85rem; }
.compare-btn:hover { background:#e65100; }
.rep-card { background:#1a1a2e; padding:10px 14px; border-radius:10px; margin-bottom:8px; }
/* Feedback IA */
.feedback-zone {
    width:100%; max-width:780px; margin-top:20px;
    background: linear-gradient(135deg, rgba(31,79,101,0.4), rgba(63,167,214,0.15));
    border-radius:16px; padding:25px;
    border:1px solid rgba(63,167,214,0.3);
}
.feedback-loading {
    display:flex; align-items:center; gap:10px; color:#aaa; font-style:italic;
}
.feedback-dot {
    width:8px; height:8px; border-radius:50%; background:#3fa7d6;
    animation: pulse 1s infinite;
}
.feedback-dot:nth-child(2){ animation-delay:0.2s; }
.feedback-dot:nth-child(3){ animation-delay:0.4s; }
.feedback-line {
    display:flex; align-items:flex-start; gap:12px;
    background:rgba(255,255,255,0.05); border-radius:12px;
    padding:14px; margin-bottom:10px;
}
.feedback-line-icon { font-size:1.3rem; min-width:30px; }
.feedback-line-text { color:#ddd; line-height:1.6; font-size:0.95rem; }
</style>
{% endblock %}

{% block javascripts %}
<script defer>

// ================= ANTI-TRICHE =================
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("keydown", e => { if(e.key==="F12") e.preventDefault(); });

// ================= TIMER =================
let finished = false;
let timeLeft = 60;
const timerEl = document.createElement("div");
Object.assign(timerEl.style, {
    position:"fixed", top:"20px", left:"20px", background:"#222",
    color:"#fff", padding:"10px 18px", borderRadius:"20px", fontWeight:"bold", zIndex:"9999"
});
timerEl.textContent = "‚è± 60s";
document.body.appendChild(timerEl);

const timerInterval = setInterval(() => {
    timeLeft--;
    timerEl.textContent = "‚è± " + timeLeft + "s";
    if(timeLeft <= 0){ clearInterval(timerInterval); sendChallengeResult(); }
    if(timeLeft <= 5){ timerEl.style.background = "red"; }
}, 1000);

// ================= DATA =================
const raw = {{ challenge.question|json_encode|raw }};
const activities = Array.isArray(raw) ? raw : (raw.questions || raw);
const successSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
const errorSound   = new Audio("https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3");

let current = 0;
let totalScore = 0;
let displayedScore = 0;
let reponsesList = [];

// ================= BADGES =================
const badges = [
    { score: 20, text: "ü•â Novice" },
    { score: 40, text: "ü•à Apprenti" },
    { score: 60, text: "ü•á Comp√©tent" },
    { score: 80, text: "üèÜ Expert" },
];
let awardedBadges = [];

function showBadge(text){
    const el = document.createElement("div");
    el.textContent = text;
    Object.assign(el.style, {
        position:"fixed", top:"40%", left:"50%", transform:"translate(-50%, -50%)",
        background:"#1f4f65", color:"#fff", padding:"15px 30px", borderRadius:"30px",
        fontSize:"1.5rem", fontWeight:"bold", zIndex:10001, opacity:0, transition:"all 0.5s"
    });
    document.body.appendChild(el);
    setTimeout(() => { el.style.opacity = 1; el.style.transform="translate(-50%, -60%) scale(1.1)"; }, 50);
    setTimeout(() => { el.style.opacity = 0; el.style.transform="translate(-50%, -80%) scale(0.8)"; }, 2000);
    setTimeout(() => { el.remove(); }, 2500);
}

function checkBadges(){
    badges.forEach(b => {
        if(totalScore >= b.score && !awardedBadges.includes(b.score)){
            awardedBadges.push(b.score);
            showBadge(b.text);
        }
    });
}

// ================= CONTAINER =================
const container = document.getElementById('challenge-container');

// ================= SCORE BADGE =================
const scoreBadge = document.createElement('div');
Object.assign(scoreBadge.style, {
    position:'fixed', top:'20px', right:'20px', background:'#1f4f65',
    color:'#fff', padding:'10px 20px', borderRadius:'25px', fontWeight:'700', zIndex:'9999'
});
scoreBadge.textContent = "Score: 0";
document.body.appendChild(scoreBadge);

let scoreInterval = null;

function updateScoreBadge(){
    const diff = totalScore - displayedScore;
    if(diff === 0) return;
    if(scoreInterval) clearInterval(scoreInterval);
    const step = diff > 0 ? 1 : -1;
    scoreInterval = setInterval(() => {
        displayedScore += step;
        scoreBadge.textContent = "Score: " + Math.round(displayedScore);
        if(displayedScore === totalScore){ clearInterval(scoreInterval); scoreInterval = null; }
    }, 16);
}

// ================= FLOATING SCORE =================
function showFloatingScore(text, color){
    const el = document.createElement("div");
    el.textContent = text;
    Object.assign(el.style, {
        position:"fixed", top:"50%", left:"50%", color:color,
        fontWeight:"bold", fontSize:"2rem", zIndex:"9999", pointerEvents:"none",
        transform:"translate(-50%,-50%)", opacity:1, transition:"all 0.8s ease-out"
    });
    document.body.appendChild(el);
    setTimeout(() => { el.style.transform="translate(-50%,-120%)"; el.style.opacity=0; }, 50);
    setTimeout(() => { el.remove(); }, 850);
}

// ================= DRAG & DROP =================
function initDragDrop(){
    let dragged = null;
    document.querySelectorAll('.drag-item').forEach(item => {
        item.addEventListener('dragstart', () => { dragged = item; });
    });
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', e => e.preventDefault());
        zone.addEventListener('drop', e => {
            e.preventDefault();
            if(!dragged) return;
            zone.textContent = dragged.textContent;
            zone.dataset.value = dragged.dataset.capital;
            if(zone.dataset.value === zone.dataset.correct){
                successSound.play();
                zone.style.background = "#4CAF50"; zone.style.color = "#fff";
                showFloatingScore("+20", "#4CAF50");
                zone.animate([{transform:'scale(1)'},{transform:'scale(1.2)'},{transform:'scale(1)'}], {duration:400});
                totalScore += 20;
            } else {
                errorSound.play();
                zone.style.background = "#f44336"; zone.style.color = "#fff";
                showFloatingScore("-10", "#f44336");
                zone.animate([{transform:'translateX(0)'},{transform:'translateX(-5px)'},{transform:'translateX(5px)'},{transform:'translateX(0)'}], {duration:400});
            }
            updateScoreBadge();
            checkBadges();
        });
    });
}

// ================= MEMORY =================
function initMemory(){
    let cardsData = [
        {label: '+20', score: 20}, {label: '+10', score: 10},
        {label: '-20', score: -20}, {label: '+5', score: 5}, {label: '-5', score: -5},
    ];
    function shuffle(a){ return a.sort(() => Math.random()-0.5); }
    let memoryBoard = container.querySelector('.memory-board');
    shuffle(cardsData).forEach(data => {
        let card = document.createElement('div');
        card.classList.add('card'); card.dataset.score = data.score;
        card.innerHTML = `<div class="card-front">üÇ†</div><div class="card-back">${data.label}</div>`;
        Object.assign(card.style, {
            width:'80px', height:'80px', display:'flex', alignItems:'center', justifyContent:'center',
            border:'2px solid #1f4f65', borderRadius:'10px', cursor:'pointer', fontWeight:'bold',
            fontSize:'1.2rem', perspective:'1000px', margin:'5px', background:'#f9fbff'
        });
        card.addEventListener('click', () => {
            card.classList.toggle('flipped');
            totalScore += parseInt(card.dataset.score);
            showFloatingScore((card.dataset.score > 0 ? "+" : "") + card.dataset.score, card.dataset.score > 0 ? "#4CAF50" : "#f44336");
            updateScoreBadge();
            checkBadges();
        });
        memoryBoard.appendChild(card);
    });
}

// ================= RENDER =================
function renderActivity(index){
    const act = activities[index];
    container.innerHTML = '';

    if(act.type === "qcm"){
        const choices = act.choices || act.options || [];
        const correct = act.correct_answer || act.correctAnswer;
        container.innerHTML = `
            <h3>${act.question}</h3>
            ${choices.map((o, i) => `
                <div class="styled-option">
                    <input type="radio" name="qcm" value="${o[0]}" id="q${i}">
                    <label for="q${i}">${o}</label>
                </div>
            `).join("")}
            <button id="next-btn" class="btn btn-primary" style="margin-top:15px;">Valider</button>
        `;
        document.getElementById("next-btn").onclick = () => {
            const sel = document.querySelector("input[name='qcm']:checked");
            if(!sel){ alert("Choisis une r√©ponse"); return; }
            const isCorrect = sel.value === correct;
            if(isCorrect){ totalScore += 20; showFloatingScore("+20", "#4CAF50"); successSound.play(); }
            else { showFloatingScore("-10", "#f44336"); errorSound.play(); }
            reponsesList.push({ question:act.question, type:'qcm', userAnswer:sel.value, correctAnswer:correct, isCorrect:isCorrect, points:isCorrect?20:0 });
            choices.forEach((o, i) => {
                const lbl = document.querySelector(`label[for="q${i}"]`);
                if(o[0] === correct){ lbl.style.background="#4CAF50"; lbl.style.color="#fff"; }
                else if(o[0] === sel.value){ lbl.style.background="#f44336"; lbl.style.color="#fff"; }
            });
            if(act.explanation){
                const exp = document.createElement("div");
                exp.textContent = "üí° " + act.explanation;
                Object.assign(exp.style, { marginTop:"10px", color:"#1f4f65", fontWeight:"600" });
                container.appendChild(exp);
            }
            updateScoreBadge(); checkBadges();
            setTimeout(next, 1500);
        };
    }
    else if(act.type === "truefalse"){
        container.innerHTML = `
            <h3>${act.question}</h3>
            <div style="display:flex; gap:20px; justify-content:center; margin:20px 0;">
                <button id="btn-true" class="btn btn-success" style="padding:15px 40px; font-size:1.2rem;">‚úÖ Vrai</button>
                <button id="btn-false" class="btn btn-danger" style="padding:15px 40px; font-size:1.2rem;">‚ùå Faux</button>
            </div>
            <div id="tf-msg" style="font-weight:bold; margin-top:10px;"></div>
        `;
        const correct = act.correct_answer;
        const msg = document.getElementById("tf-msg");
        function handleTF(answer){
            const isCorrect = answer === correct;
            if(isCorrect){ totalScore += 20; showFloatingScore("+20","#4CAF50"); successSound.play(); msg.textContent = "‚úÖ Bonne r√©ponse !"; msg.style.color = "#4CAF50"; }
            else { showFloatingScore("-10","#f44336"); errorSound.play(); msg.textContent = "‚ùå Mauvaise r√©ponse !"; msg.style.color = "#f44336"; }
            if(act.explanation){ msg.textContent += " ‚Äî üí° " + act.explanation; }
            reponsesList.push({ question:act.question, type:'truefalse', userAnswer:String(answer), correctAnswer:String(correct), isCorrect:isCorrect, points:isCorrect?20:0 });
            document.getElementById("btn-true").disabled = true;
            document.getElementById("btn-false").disabled = true;
            updateScoreBadge(); checkBadges();
            setTimeout(next, 1800);
        }
        document.getElementById("btn-true").onclick  = () => handleTF(true);
        document.getElementById("btn-false").onclick = () => handleTF(false);
    }
    else if(act.type === "open"){
        container.innerHTML = `
            <h3>${act.question}</h3>
            <div class="styled-input">
                <textarea id="open-answer" rows="4" placeholder="√âcris ta r√©ponse ici..."
                    style="width:100%;padding:12px;border-radius:12px;border:2px solid #1f4f65;font-size:1rem;"></textarea>
            </div>
            <button id="next-btn" class="btn btn-primary" style="margin-top:15px;">Valider</button>
            <div id="open-msg" style="margin-top:10px;font-weight:bold;"></div>
        `;
        document.getElementById("next-btn").onclick = () => {
            const answer = document.getElementById("open-answer").value.trim().toLowerCase();
            if(!answer){ alert("√âcris ta r√©ponse"); return; }
            const keywords = act.expected_keywords || [];
            const found = keywords.filter(kw => answer.includes(kw.toLowerCase()));
            const points = keywords.length > 0 ? Math.round((found.length / keywords.length) * 20) : 10;
            totalScore += points;
            showFloatingScore("+" + points, "#4CAF50");
            reponsesList.push({ question:act.question, type:'open', userAnswer:answer, correctAnswer:act.model_answer||'', isCorrect:points>0, points:points });
            updateScoreBadge(); checkBadges();
            const msg = document.getElementById("open-msg");
            msg.innerHTML = `üìù R√©ponse mod√®le : <em>${act.model_answer}</em><br>üîë Mots-cl√©s trouv√©s : ${found.length}/${keywords.length}`;
            msg.style.color = "#1f4f65";
            document.getElementById("next-btn").disabled = true;
            setTimeout(next, 2500);
        };
    }
    else if(act.type === "texte"){
        container.innerHTML = `<h3>${act.question}</h3><div class="styled-input"><input type="text" id="text-answer" placeholder="R√©ponse"></div><button id="next-btn" class="btn btn-primary" style="margin-top:15px;">Valider</button>`;
        document.getElementById("next-btn").onclick = () => {
            const answer = document.getElementById("text-answer").value.trim();
            if(answer === ""){ alert("√âcris ta r√©ponse"); return; }
            const isCorrect = answer === act.correctAnswer;
            if(isCorrect){ totalScore += 20; showFloatingScore("+20","#4CAF50"); }
            else { showFloatingScore("-10","#f44336"); }
            reponsesList.push({ question:act.question, type:'texte', userAnswer:answer, correctAnswer:act.correctAnswer||'', isCorrect:isCorrect, points:isCorrect?20:0 });
            updateScoreBadge();
            setTimeout(next, 1200);
        };
    }
    else if(act.type === "dragdrop"){
        const countries = Object.keys(act.options);
        const capitals  = Object.values(act.options);
        container.innerHTML = `<h3>${act.question}</h3>
            <div class="drag-items">${countries.map(c=>`<div class="drag-item" draggable="true" data-capital="${act.options[c]}">${c}</div>`).join("")}</div>
            <div class="drop-zones">${capitals.map(cap=>`<div class="drop-zone" data-correct="${cap}">${cap}</div>`).join("")}</div>
            <button id="next-btn" class="btn btn-primary" style="margin-top:15px;">Suivant</button>`;
        initDragDrop();
        document.getElementById("next-btn").onclick = () => {
            reponsesList.push({ question:act.question, type:'dragdrop', userAnswer:'(drag&drop)', correctAnswer:'', isCorrect:true, points:0 });
            next();
        };
    }
    else if(act.type === "memory"){
        container.innerHTML = `<h3>${act.question}</h3><div class="memory-board" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;"></div><div style="margin-top:15px;">Score: <span id="memory-score">0</span></div><button id="next-btn" class="btn btn-primary" style="margin-top:20px;">Suivant</button>`;
        initMemory();
        document.getElementById("next-btn").onclick = () => {
            reponsesList.push({ question:act.question, type:'memory', userAnswer:'(memory)', correctAnswer:'', isCorrect:true, points:0 });
            next();
        };
    }
    else if(act.type === "puzzle"){
        let correct = [...act.options];
        let cur = [...correct].sort(() => Math.random()-0.5);
        container.innerHTML = `<h3>${act.question}</h3><ul id="puzzle-list" style="list-style:none;padding:0;"></ul><button id="check-btn" class="btn btn-success">Valider</button><div id="puzzle-msg" style="margin-top:15px;font-weight:bold"></div>`;
        const list = document.getElementById("puzzle-list");
        const msg  = document.getElementById("puzzle-msg");
        function draw(){
            list.innerHTML = "";
            cur.forEach((text, i) => {
                const li = document.createElement("li"); li.textContent = text; li.draggable = true;
                Object.assign(li.style, {padding:"12px",margin:"8px 0",background:"#eef2ff",borderRadius:"12px",cursor:"grab",fontWeight:"500",transition:"0.25s",boxShadow:"0 2px 6px rgba(0,0,0,0.1)"});
                li.addEventListener("dragstart", e => { e.dataTransfer.setData("index", i); li.style.opacity = "0.4"; });
                li.addEventListener("dragend", () => { li.style.opacity = "1"; });
                li.addEventListener("dragover", e => e.preventDefault());
                li.addEventListener("drop", e => { e.preventDefault(); const from = e.dataTransfer.getData("index"); [cur[from],cur[i]]=[cur[i],cur[from]]; draw(); });
                list.appendChild(li);
            });
        }
        draw();
        document.getElementById("check-btn").onclick = () => {
            let good = 0; cur.forEach((v, i) => { if(v === correct[i]) good++; });
            let p = Math.round((good/correct.length)*100);
            totalScore += p;
            showFloatingScore("+" + p, "#4CAF50");
            updateScoreBadge();
            reponsesList.push({ question:act.question, type:'puzzle', userAnswer:cur.join(' ‚Üí '), correctAnswer:correct.join(' ‚Üí '), isCorrect:p===100, points:p });
            if(p === 100){ msg.textContent="‚úÖ Parfait !"; msg.style.color="green"; }
            else if(p >= 50){ msg.textContent="üôÇ Presque !"; msg.style.color="orange"; }
            else { msg.textContent="‚ùå Incorrect"; msg.style.color="red"; }
            setTimeout(next, 1200);
        };
    }
    else { next(); }
}

// ================= NEXT =================
function next(){ current++; if(current < activities.length){ renderActivity(current); } else { sendChallengeResult(); } }

// ================= FEEDBACK IA =================
function fetchFeedbackIA(percent, win){
    const feedbackZone = document.createElement('div');
    feedbackZone.className = 'feedback-zone';
    feedbackZone.innerHTML = `
        <h3 style="color:#3fa7d6; margin-bottom:15px; font-size:1.1rem;">ü§ñ Feedback personnalis√© IA</h3>
        <div class="feedback-loading" id="feedback-loading">
            <div class="feedback-dot"></div>
            <div class="feedback-dot"></div>
            <div class="feedback-dot"></div>
            <span style="margin-left:8px;">G√©n√©ration du feedback en cours...</span>
        </div>
        <div id="feedback-content" style="display:none;"></div>
    `;
    win.appendChild(feedbackZone);

    fetch('/challenge/{{ challenge.id }}/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'score=' + percent
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('feedback-loading').style.display = 'none';
        const content = document.getElementById('feedback-content');
        content.style.display = 'block';

        if(data.success){
            const statusColor = data.reussi ? '#4CAF50' : '#FF9800';
            const statusText  = data.reussi ? '‚úÖ Objectif atteint !' : 'üí™ Continue tes efforts !';

            // Parser les 3 points du feedback
            const icons = ['‚úÖ', '‚≠ê', 'üí°'];
            const colors = ['#4CAF50', '#FF9800', '#2196F3'];
            const lines = data.feedback.split('\n').filter(l => l.trim() !== '');
            const formattedLines = lines.map((line, i) => {
                const cleanLine = line.replace(/^\d+\.\s*/, '').trim();
                const icon  = icons[i] || 'üìå';
                const color = colors[i] || '#ddd';
                return `
                    <div class="feedback-line">
                        <div class="feedback-line-icon">${icon}</div>
                        <div class="feedback-line-text" style="color:${color === '#4CAF50' ? '#a8f0a8' : color === '#FF9800' ? '#ffd090' : '#90c8ff'}">
                            ${cleanLine}
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `
                <div style="background:rgba(255,255,255,0.07); padding:12px 16px; border-radius:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <span style="color:${statusColor}; font-weight:bold; font-size:1rem;">${statusText}</span>
                    <span style="color:#aaa; font-size:0.85rem;">
                        Objectif : <strong style="color:#fff;">{{ challenge.objectifscore }}%</strong>
                        &nbsp;|&nbsp;
                        Ton score : <strong style="color:${statusColor};">${percent}%</strong>
                    </span>
                </div>
                ${formattedLines || `<div class="feedback-line"><div class="feedback-line-text">${data.feedback}</div></div>`}
            `;
        } else {
            content.innerHTML = `
                <div style="color:#f44336; padding:10px; background:rgba(244,67,54,0.1); border-radius:10px;">
                    ‚ùå Feedback indisponible : ${data.error || 'erreur inconnue'}
                </div>
            `;
        }
    })
    .catch(() => {
        document.getElementById('feedback-loading').style.display = 'none';
        document.getElementById('feedback-content').style.display = 'block';
        document.getElementById('feedback-content').innerHTML = `
            <div style="color:#f44336; padding:10px; background:rgba(244,67,54,0.1); border-radius:10px;">
                ‚ùå Impossible de g√©n√©rer le feedback.
            </div>
        `;
    });
}

// ================= SHOW VICTORY =================
function showVictory(percent, niveau){
    fetch('/challenge/{{ challenge.id }}/history')
    .then(r => r.json())
    .then(history => {
        const win = document.createElement("div");
        Object.assign(win.style, {
            position:"fixed", inset:"0", background:"rgba(10,15,30,0.97)",
            color:"#fff", zIndex:"10000", overflowY:"auto",
            display:"flex", flexDirection:"column", alignItems:"center", padding:"40px 20px"
        });

        const badgesList = [{score:20,text:"ü•â Novice"},{score:40,text:"ü•à Apprenti"},{score:60,text:"ü•á Comp√©tent"},{score:80,text:"üèÜ Expert"}];
        let awardedBadge = badgesList[0].text;
        for(let b of badgesList){ if(percent >= b.score) awardedBadge = b.text; }

        const rows = history.map((h, i) => {
            const isCurrent = i === history.length - 1;
            const scoreColor = h.score>=80?"#4CAF50":h.score>=50?"#FF9800":"#f44336";
            return `<tr style="background:${isCurrent?'rgba(31,79,101,0.4)':'transparent'};">
                <td style="padding:12px 15px; font-weight:bold;">#${h.attemptNumber}</td>
                <td style="padding:12px 15px; color:${scoreColor}; font-weight:bold;">${h.score}%</td>
                <td style="padding:12px 15px;">${h.badge || '-'}</td>
                <td style="padding:12px 15px; color:#aaa; font-size:0.85rem;">${h.createdAt}</td>
                <td style="padding:12px 15px;">
                    ${isCurrent
                        ? `<span style="color:#4CAF50; font-size:0.85rem;">‚úì Actuelle</span>`
                        : `<button class="compare-btn" onclick="compareAttempts(${i}, ${history.length-1})">üîç Comparer</button>`
                    }
                </td>
            </tr>`;
        }).join('');

        win.innerHTML = `
            <div style="font-size:2.5rem; margin-bottom:8px;">üèÜ Challenge termin√© !</div>
            <div style="font-size:1.2rem; margin-bottom:5px;">
                Score : <strong style="color:#4CAF50">${percent}%</strong>
            </div>
            <div style="font-size:1rem; margin-bottom:30px; color:#aaa;">${awardedBadge}</div>

            <div style="width:100%; max-width:780px; margin-bottom:25px;">
                <h3 style="color:#FF9800; margin-bottom:12px;">üìã Toutes tes tentatives</h3>
                <div style="background:rgba(255,255,255,0.05); border-radius:16px; overflow:hidden;">
                    <table class="victory-table">
                        <thead>
                            <tr>
                                <th>Tentative</th>
                                <th>Score</th>
                                <th>Badge</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows || '<tr><td colspan="5" style="text-align:center;padding:20px;color:#aaa;">Premi√®re tentative !</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="comparison-zone" style="display:none; width:100%; max-width:780px; margin-bottom:25px;">
                <h3 style="color:#2196F3; margin-bottom:12px;">üîç Comparaison c√¥te √† c√¥te</h3>
                <div id="comparison-content" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
                <div id="progression-indicator" style="text-align:center; font-size:1.1rem; margin-top:15px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px;"></div>
            </div>

            <div style="display:flex; gap:15px; flex-wrap:wrap; justify-content:center; margin-top:10px; margin-bottom:25px;">
                <button onclick="window.location.reload()"
                    style="padding:12px 28px;border-radius:12px;border:none;background:#4CAF50;color:#fff;cursor:pointer;font-size:1rem;font-weight:bold;">
                    üîÑ R√©essayer
                </button>
                <button onclick="window.location.href='/examen/${percent>=50?'moyen':'facile'}'"
                    style="padding:12px 28px;border-radius:12px;border:none;background:#9C27B0;color:#fff;cursor:pointer;font-size:1rem;font-weight:bold;">
                    üìù Passer l'examen
                </button>
                <button onclick="window.location.href='{{ path('leaderboard') }}'"
                    style="padding:12px 28px;border-radius:12px;border:none;background:#2196F3;color:#fff;cursor:pointer;font-size:1rem;font-weight:bold;">
                    üèÖ Leaderboard
                </button>
            </div>
        `;
        document.body.appendChild(win);
        window._history = history;

        // ‚Üê APPEL FEEDBACK IA ICI
        fetchFeedbackIA(percent, win);
    })
    .catch(() => {
        const win = document.createElement("div");
        Object.assign(win.style, {
            position:"fixed", inset:"0", background:"rgba(0,0,0,0.95)",
            display:"flex", alignItems:"center", justifyContent:"center",
            flexDirection:"column", color:"#fff", fontSize:"2rem", zIndex:"10000"
        });
        win.innerHTML = `
            <div>üèÜ Challenge termin√© !</div>
            <div style="font-size:1.3rem;margin-top:15px;">Score : ${percent}%</div>
            <div style="margin-top:30px;display:flex;gap:15px;flex-wrap:wrap;justify-content:center;">
                <button onclick="window.location.reload()"
                    style="padding:12px 28px;border-radius:12px;border:none;background:#4CAF50;color:#fff;cursor:pointer;font-size:1rem;">
                    üîÑ R√©essayer
                </button>
                <button onclick="window.location.href='{{ path('leaderboard') }}'"
                    style="padding:12px 28px;border-radius:12px;border:none;background:#2196F3;color:#fff;cursor:pointer;font-size:1rem;">
                    üèÖ Leaderboard
                </button>
            </div>
        `;
        document.body.appendChild(win);
    });
}

// ================= COMPARE =================
function compareAttempts(indexA, indexB){
    const history = window._history;
    const a = history[indexA];
    const b = history[indexB];

    document.getElementById('comparison-zone').style.display = 'block';

    function buildCol(attempt, label, color){
        const repRows = (attempt.reponses || []).map(rep => `
            <div class="rep-card" style="border-left:4px solid ${rep.isCorrect?'#4CAF50':'#f44336'};">
                <div style="font-size:0.75rem; color:#aaa; margin-bottom:4px;">${rep.question}</div>
                <div style="font-size:0.88rem;">
                    R√©ponse : <strong style="color:${rep.isCorrect?'#4CAF50':'#f44336'}">${rep.userAnswer}</strong>
                    ${rep.isCorrect ? '‚úÖ' : '‚ùå'}
                </div>
                ${!rep.isCorrect && rep.correctAnswer
                    ? `<div style="font-size:0.78rem;color:#aaa;margin-top:3px;">‚úì Correct : ${rep.correctAnswer}</div>`
                    : ''
                }
                <div style="font-size:0.75rem; color:#FF9800; margin-top:2px;">+${rep.points} pts</div>
            </div>
        `).join('') || '<div style="color:#aaa;font-style:italic;padding:10px;">Aucune r√©ponse enregistr√©e</div>';

        return `
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:14px;">
                <div style="color:${color}; font-weight:bold; margin-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px;">
                    ${label} ‚Äî ${attempt.score}%<br>
                    <span style="font-size:0.8rem; color:#aaa;">${attempt.createdAt}</span>
                </div>
                ${repRows}
            </div>
        `;
    }

    document.getElementById('comparison-content').innerHTML =
        buildCol(a, `Tentative #${a.attemptNumber}`, '#FF9800') +
        buildCol(b, 'Tentative actuelle', '#2196F3');

    const delta = b.score - a.score;
    const ind = document.getElementById('progression-indicator');
    if(delta > 0){
        ind.innerHTML = `üìà Tu as progress√© de <strong style="color:#4CAF50; font-size:1.3rem;">+${delta}%</strong> par rapport √† ta tentative #${a.attemptNumber}`;
    } else if(delta < 0){
        ind.innerHTML = `üìâ Tu as r√©gress√© de <strong style="color:#f44336; font-size:1.3rem;">${delta}%</strong> par rapport √† ta tentative #${a.attemptNumber}`;
    } else {
        ind.innerHTML = `‚û°Ô∏è Score identique √† ta tentative #${a.attemptNumber} ‚Äî continue comme √ßa !`;
    }

    document.getElementById('comparison-zone').scrollIntoView({ behavior:'smooth' });
}

// ================= SEND RESULT =================
function sendChallengeResult(){
    if(finished) return; finished = true;
    clearInterval(timerInterval);

    let percent = Math.round(totalScore);
    if(percent > 100) percent = 100;
    let niveau = percent >= 80 ? "difficile" : percent >= 50 ? "moyen" : "facile";

    document.getElementById("last-score").textContent  = percent + "%";
    document.getElementById("last-niveau").textContent = niveau;

    fetch('/challenge/{{ challenge.id }}/update-score', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ score: percent, niveau: niveau, reponses: reponsesList })
    }).then(() => {
        showVictory(percent, niveau);
    }).catch(() => {
        showVictory(percent, niveau);
    });
}

// ================= START =================
renderActivity(current);

</script>
{% endblock %}