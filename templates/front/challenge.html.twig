{% extends 'front/home.html.twig' %}

{% block title %}{{ challenge.titrec }} | LearnFlex+{% endblock %}

{% block header %}
<header class="landing-header">
    <div class="container">
        <div class="header-left">
            <div class="logo">
                <img src="{{ asset('assets/images/logo1.png') }}" alt="Learnflexplus Logo" class="main-logo">
                <span class="logo-text">LearnFlex +</span>
            </div>
        </div>
        <nav class="main-nav">
            <ul>
                <li class="active"><a href="#">Accueil</a></li>
                <li><a href="#">Contenus pÃ©dagogiques</a></li>
                <li><a href="{{ path('front_evaluation') }}">Evaluation</a></li>
                <li><a href="#">Questionnaire</a></li>
                <li><a href="#">Orientation</a></li>
                <li><a href="#">Forum</a></li>
            </ul>
        </nav>
        <div class="header-right">
            {% if app.user and app.user.role != 'client' %}
                <a href="#" class="btn btn-outline dashboard-btn">Dashboard</a>
            {% endif %}
            {% if app.user %}
                <a href="#" class="btn btn-primary logout-btn">DÃ©connexion</a>
            {% else %}
                <a href="#" class="btn btn-primary">Connexion</a>
            {% endif %}
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</header>
{% endblock %}

{% block body %}
<main class="challenge-ui">

    <!-- HERO -->
    <section class="challenge-hero">
        <div class="hero-overlay"></div>
        <div class="container hero-content">
            <span class="hero-badge">ğŸ¯ Challenge</span>
            <h1>{{ challenge.titrec }}</h1>
            <p>{{ challenge.descriptionc }}</p>

            <div class="hero-stats">
                <div class="stat-card">
                    <span>Objectif</span>
                    <strong>{{ challenge.objectifscore }}%</strong>
                </div>
                <div class="stat-card">
                    <span>Progression</span>
                    <strong>{{ challenge.progressionactuelle }}%</strong>
                </div>
                <div class="stat-card">
                    <span>Niveau atteint</span>
                    <strong>{{ challenge.niveauatteint }}</strong>
                </div>
                <div class="stat-card">
                    <span>RÃ©compense</span>
                    <strong>{{ challenge.typerecomponse }}</strong>
                </div>
                <div class="stat-card">
                    <span>Dernier Score</span>
                    <strong id="last-score">{{ challenge.dernierScore ?: '-' }}</strong>
                </div>

                <div class="stat-card">
                    <span>Dernier Niveau</span>
                    <strong id="last-niveau">{{ challenge.dernierNiveau ?: '-' }}</strong>
                </div>

                <div class="stat-card">
                    <span>DerniÃ¨res RÃ©ponses</span>
                    <strong>{{ challenge.reponses ? challenge.reponses|join(', ') : '-' }}</strong>
                </div>
            </div>
        </div>
    </section>

    <!-- CONTENU -->
    <section class="challenge-content container">
        {% if challenge.question %}
            <div class="content-card">
                <h3>ğŸ§  ActivitÃ© interactive</h3>
                <p class="subtitle">ComplÃ¨te ce challenge pour dÃ©bloquer lâ€™examen associÃ© (Interacty)</p>

                <div id="challenge-container"></div>
                <button id="next-btn" style="display:none;">Suivant</button>
            </div>
        {% else %}
            <div class="empty-state">
                <p>Aucune activitÃ© interactive disponible.</p>
            </div>
        {% endif %}
    </section>
    <div style="text-align:center; margin-top:20px;">
    <a href="{{ path('challenge_train', { id: challenge.id }) }}" class="cta-btn">
        ğŸ¯ EntraÃ®ne-toi
    </a>
</div>

</main>
{% endblock %}

{% block stylesheets %}
<style>
/* =======================
   STYLE COMPLET
======================= */
.challenge-ui { font-family: 'Poppins', sans-serif; background: #f6f8fc; }
.memory-board {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    max-width: 400px;
}
.cta-btn {
    position: relative;
    display: inline-block;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: bold;
    color: #1e90ff;              /* texte bleu */
    background: rgba(255, 255, 255, 0.1);  /* lÃ©ger fond transparent */
    border: 2px solid #1e90ff;   /* contour bleu */
    border-radius: 30px;
    text-decoration: none;
    overflow: hidden;
    transition: all 0.3s ease;
}

/* effet hover avec contour animÃ© et fond */
.cta-btn::before {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 100%;
    height: 100%;
    background: #1e90ff;          /* couleur de survol */
    transition: all 0.3s ease;
    z-index: 0;
}

.cta-btn:hover::before {
    left: 0;
}

.cta-btn:hover {
    color: #fff; /* texte blanc au survol */
}

/* texte au-dessus du pseudo-Ã©lÃ©ment */
.cta-btn span {
    position: relative;
    z-index: 1;
}
.card {
    width: 80px;
    height: 120px;
    perspective: 600px;
    cursor: pointer;
    position: relative;
}
.card-front, .card-back {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    backface-visibility: hidden;
    border: 1px solid #333;
    border-radius: 10px;
    font-size: 20px;
    position: absolute;
    transition: transform 0.5s;
}
.card-front {
    background: #1e90ff;
    color: white;
}
.card-back {
    background: #ffeb3b;
    color: black;
    transform: rotateY(180deg);
}
.card.flipped .card-front {
    transform: rotateY(180deg);
}
.card.flipped .card-back {
    transform: rotateY(0deg);
}
/* ===== PUZZLE DRAG & DROP ===== */
.puzzle-steps li {
    padding: 15px 20px;
    margin: 10px 0;
    background: #f9fbff;
    border: 2px solid #1f4f65;
    border-radius: 12px;
    cursor: grab;
    font-weight: 600;
    transition: background 0.3s, transform 0.2s;
    user-select: none;
}

.puzzle-steps li.dragging {
    opacity: 0.6;
    transform: scale(1.05);
    background: #1f4f65;
    color: #fff;
}

.puzzle-steps {
    list-style: none;
    padding: 0;
    max-width: 500px;
    margin: 20px auto;
}

.challenge-hero {
    position: relative;
    padding: 100px 0;
    background: linear-gradient(135deg, #3fa7d6, #1f4f65);
    color: #fff;
    overflow: hidden;
    border-bottom-left-radius: 40px;
    border-bottom-right-radius: 40px;
}
@keyframes fadeIn{
 from{opacity:0;transform:scale(.8)}
 to{opacity:1;transform:scale(1)}
}

.hero-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.08); }
.hero-content { position: relative; z-index: 2; text-align: center; }
.hero-badge { background: #97c3a2; padding: 8px 22px; border-radius: 50px; font-weight:700; display:inline-block; margin-bottom:18px; color:#fff; }

.challenge-hero h1 { font-size: 3rem; font-weight: 800; color:#fff; text-shadow:0 3px 8px rgba(0,0,0,0.25); }
.challenge-hero p { max-width: 720px; margin:auto; opacity:0.95; color:#f0f8ff; text-shadow:0 1px 4px rgba(0,0,0,0.2); }

.hero-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:20px; margin-top:45px; }
.stat-card { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius:22px; padding:25px; text-align:center; color:#1f4f65; }
.stat-card span { display:block; font-size:0.85rem; color:#555; }
.stat-card strong { font-size:1.5rem; font-weight:700; }

.challenge-content { margin-top:-60px; position: relative; z-index:3; }
.content-card { background:#fff; border-radius:26px; padding:40px; box-shadow:0 20px 50px rgba(0,0,0,0.12); }
.content-card h3 { font-weight:700; color:#1f4f65; }
.subtitle { color:#555; margin-bottom:30px; }

.drag-items { display:flex; justify-content:center; gap:15px; margin:20px 0; }
.drag-item { padding:10px 20px; background:#1f4f65; color:#fff; border-radius:10px; cursor:grab; }
.drop-zones { display:flex; justify-content:center; gap:20px; }
.drop-zone { width:150px; height:100px; border:2px dashed #1f4f65; border-radius:15px; display:flex; align-items:center; justify-content:center; font-weight:bold; background:#f9fbff; }

.empty-state { background:#fff; border-radius:20px; padding:40px; text-align:center; color:#777; }
</style>
{% endblock %}


{% block javascripts %}
<script defer>

// ================= ANTI-TRICHE =================
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("keydown", e => { if(e.key==="F12") e.preventDefault(); });

// ================= TIMER =================
let finished = false;
let timeLeft = 60;
const timerEl = document.createElement("div");
Object.assign(timerEl.style,{
 position:"fixed", top:"20px", left:"20px", background:"#222",
 color:"#fff", padding:"10px 18px", borderRadius:"20px", fontWeight:"bold",
 zIndex:"9999"
});
timerEl.textContent="â± 60s";
document.body.appendChild(timerEl);

const timerInterval = setInterval(()=>{
 timeLeft--;
 timerEl.textContent="â± "+timeLeft+"s";
 if(timeLeft<=0){ clearInterval(timerInterval); sendChallengeResult(); }
 if(timeLeft <= 5){ timerEl.style.background = "red"; }
},1000);

// ================= DATA =================
const raw = {{ challenge.question|json_encode|raw }};
const activities = Array.isArray(raw) ? raw : (raw.questions || raw);
const successSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
const errorSound   = new Audio("https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3");

let current = 0;
let totalScore = 0;
let displayedScore = 0;

// ================= BADGES =================
const badges = [
    { score: 20, text: "ğŸ¥‰ Novice" },
    { score: 40, text: "ğŸ¥ˆ Apprenti" },
    { score: 60, text: "ğŸ¥‡ CompÃ©tent" },
    { score: 80, text: "ğŸ† Expert" },
];
let awardedBadges = [];

function showBadge(text){
    const el = document.createElement("div");
    el.textContent = text;
    Object.assign(el.style,{
        position:"fixed", top:"40%", left:"50%", transform:"translate(-50%, -50%)",
        background:"#1f4f65", color:"#fff", padding:"15px 30px", borderRadius:"30px",
        fontSize:"1.5rem", fontWeight:"bold", zIndex:10001, opacity:0, transition:"all 0.5s"
    });
    document.body.appendChild(el);
    setTimeout(()=>{ el.style.opacity = 1; el.style.transform="translate(-50%, -60%) scale(1.1)"; },50);
    setTimeout(()=>{ el.style.opacity = 0; el.style.transform="translate(-50%, -80%) scale(0.8)"; },2000);
    setTimeout(()=>{ el.remove(); },2500);
}

function checkBadges(){
    badges.forEach(b => {
        if(totalScore >= b.score && !awardedBadges.includes(b.score)){
            awardedBadges.push(b.score);
            showBadge(b.text);
        }
    });
}

// ================= CONTAINER =================
const container = document.getElementById('challenge-container');

// ================= SCORE BADGE =================
const scoreBadge = document.createElement('div');
Object.assign(scoreBadge.style,{
 position:'fixed', top:'20px', right:'20px', background:'#1f4f65',
 color:'#fff', padding:'10px 20px', borderRadius:'25px', fontWeight:'700', zIndex:'9999'
});
scoreBadge.textContent="Score: 0";
document.body.appendChild(scoreBadge);

let scoreInterval = null;

function updateScoreBadge(){
    const diff = totalScore - displayedScore;
    if(diff === 0) return;
    if(scoreInterval) clearInterval(scoreInterval);
    const step = diff>0 ? 1 : -1;
    scoreInterval = setInterval(()=>{
        displayedScore += step;
        scoreBadge.textContent = "Score: " + Math.round(displayedScore);
        if(displayedScore===totalScore){ clearInterval(scoreInterval); scoreInterval=null; }
    },16);
}

// ================= FLOATING SCORE =================
function showFloatingScore(text,color){
    const el = document.createElement("div");
    el.textContent = text;
    Object.assign(el.style,{
        position:"fixed", top:"50%", left:"50%", color:color,
        fontWeight:"bold", fontSize:"2rem", zIndex:"9999", pointerEvents:"none",
        transform:"translate(-50%,-50%)", opacity:1, transition:"all 0.8s ease-out"
    });
    document.body.appendChild(el);
    setTimeout(()=>{ el.style.transform="translate(-50%,-120%)"; el.style.opacity=0; },50);
    setTimeout(()=>{ el.remove(); },850);
}

// ================= DRAG & DROP =================
function initDragDrop(){
    let dragged = null;
    document.querySelectorAll('.drag-item').forEach(item=>{
        item.addEventListener('dragstart',()=>{ dragged=item; });
    });
    document.querySelectorAll('.drop-zone').forEach(zone=>{
        zone.addEventListener('dragover',e=>e.preventDefault());
        zone.addEventListener('drop',e=>{
            e.preventDefault();
            if(!dragged) return;
            zone.textContent = dragged.textContent;
            zone.dataset.value = dragged.dataset.capital;
            if(zone.dataset.value===zone.dataset.correct){
                successSound.play();
                zone.style.background="#4CAF50"; zone.style.color="#fff";
                showFloatingScore("+20","#4CAF50");
                zone.animate([{transform:'scale(1)'},{transform:'scale(1.2)'},{transform:'scale(1)'}],{duration:400});
                totalScore += 20;
            } else{
                errorSound.play();
                zone.style.background="#f44336"; zone.style.color="#fff";
                showFloatingScore("-10","#f44336");
                zone.animate([{transform:'translateX(0)'},{transform:'translateX(-5px)'},{transform:'translateX(5px)'},{transform:'translateX(0)'}],{duration:400});
            }
            updateScoreBadge();
            checkBadges();
        });
    });
}

// ================= MEMORY =================
function initMemory(){
    let cardsData = [
        {label: '+20', score: 20},
        {label: '+10', score: 10},
        {label: '-20', score: -20},
        {label: '+5', score: 5},
        {label: '-5', score: -5},
    ];
    function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
    let memoryBoard = container.querySelector('.memory-board');
    shuffle(cardsData).forEach(data=>{
        let card = document.createElement('div');
        card.classList.add('card'); card.dataset.score=data.score;
        card.innerHTML=`<div class="card-front">ğŸ‚ </div><div class="card-back">${data.label}</div>`;
        Object.assign(card.style,{
            width:'80px', height:'80px', display:'flex', alignItems:'center', justifyContent:'center',
            border:'2px solid #1f4f65', borderRadius:'10px', cursor:'pointer', fontWeight:'bold',
            fontSize:'1.2rem', perspective:'1000px', margin:'5px', background:'#f9fbff'
        });
        card.addEventListener('click', ()=>{
            card.classList.toggle('flipped');
            totalScore += parseInt(card.dataset.score);
            showFloatingScore((card.dataset.score>0?"+":"")+card.dataset.score, card.dataset.score>0?"#4CAF50":"#f44336");
            updateScoreBadge();
            checkBadges();
        });
        memoryBoard.appendChild(card);
    });
}

// ================= RENDER =================
function renderActivity(index){
    const act = activities[index];
    container.innerHTML='';

    // â”€â”€ QCM (Groq : choices + correct_answer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if(act.type === "qcm"){
        const choices = act.choices || act.options || [];
        const correct = act.correct_answer || act.correctAnswer;

        container.innerHTML = `
            <h3>${act.question}</h3>
            ${choices.map((o, i) => `
                <div class="styled-option">
                    <input type="radio" name="qcm" value="${o[0]}" id="q${i}">
                    <label for="q${i}">${o}</label>
                </div>
            `).join("")}
            <button id="next-btn" class="btn btn-primary">Suivant</button>
        `;

        document.getElementById("next-btn").onclick = () => {
            const sel = document.querySelector("input[name='qcm']:checked");
            if(!sel){ alert("Choisis une rÃ©ponse"); return; }

            if(sel.value === correct){
                totalScore += 20;
                showFloatingScore("+20", "#4CAF50");
                successSound.play();
            } else {
                showFloatingScore("-10", "#f44336");
                errorSound.play();
            }

            choices.forEach((o, i) => {
                const lbl = document.querySelector(`label[for="q${i}"]`);
                if(o[0] === correct){ lbl.style.background="#4CAF50"; lbl.style.color="#fff"; }
                else if(o[0] === sel.value){ lbl.style.background="#f44336"; lbl.style.color="#fff"; }
            });

            if(act.explanation){
                const exp = document.createElement("div");
                exp.textContent = "ğŸ’¡ " + act.explanation;
                Object.assign(exp.style, { marginTop:"10px", color:"#1f4f65", fontWeight:"600" });
                container.appendChild(exp);
            }

            updateScoreBadge(); checkBadges();
            setTimeout(next, 1500);
        };
    }

    // â”€â”€ VRAI / FAUX (Groq : correct_answer = true/false) â”€â”€â”€â”€â”€
    else if(act.type === "truefalse"){
        container.innerHTML = `
            <h3>${act.question}</h3>
            <div style="display:flex; gap:20px; justify-content:center; margin:20px 0;">
                <button id="btn-true"  class="btn btn-success" style="padding:15px 40px; font-size:1.2rem;">âœ… Vrai</button>
                <button id="btn-false" class="btn btn-danger"  style="padding:15px 40px; font-size:1.2rem;">âŒ Faux</button>
            </div>
            <div id="tf-msg" style="font-weight:bold; margin-top:10px;"></div>
        `;

        const correct = act.correct_answer;
        const msg = document.getElementById("tf-msg");

        function handleTF(answer){
            if(answer === correct){
                totalScore += 20; showFloatingScore("+20","#4CAF50"); successSound.play();
                msg.textContent = "âœ… Bonne rÃ©ponse !"; msg.style.color = "#4CAF50";
            } else {
                showFloatingScore("-10","#f44336"); errorSound.play();
                msg.textContent = "âŒ Mauvaise rÃ©ponse !"; msg.style.color = "#f44336";
            }
            if(act.explanation){ msg.textContent += " â€” ğŸ’¡ " + act.explanation; }
            document.getElementById("btn-true").disabled = true;
            document.getElementById("btn-false").disabled = true;
            updateScoreBadge(); checkBadges();
            setTimeout(next, 1800);
        }

        document.getElementById("btn-true").onclick  = () => handleTF(true);
        document.getElementById("btn-false").onclick = () => handleTF(false);
    }

    // â”€â”€ QUESTION OUVERTE (Groq : expected_keywords + model_answer)
    else if(act.type === "open"){
        container.innerHTML = `
            <h3>${act.question}</h3>
            <div class="styled-input">
                <textarea id="open-answer" rows="4" placeholder="Ã‰cris ta rÃ©ponse ici..."
                    style="width:100%;padding:12px;border-radius:12px;border:2px solid #1f4f65;font-size:1rem;"></textarea>
            </div>
            <button id="next-btn" class="btn btn-primary" style="margin-top:15px;">Valider</button>
            <div id="open-msg" style="margin-top:10px;font-weight:bold;"></div>
        `;

        document.getElementById("next-btn").onclick = () => {
            const answer = document.getElementById("open-answer").value.trim().toLowerCase();
            if(!answer){ alert("Ã‰cris ta rÃ©ponse"); return; }

            const keywords = act.expected_keywords || [];
            const found = keywords.filter(kw => answer.includes(kw.toLowerCase()));
            const points = keywords.length > 0 ? Math.round((found.length / keywords.length) * 20) : 10;

            totalScore += points;
            showFloatingScore("+" + points, "#4CAF50");
            updateScoreBadge(); checkBadges();

            const msg = document.getElementById("open-msg");
            msg.innerHTML = `ğŸ“ RÃ©ponse modÃ¨le : <em>${act.model_answer}</em><br>ğŸ”‘ Mots-clÃ©s trouvÃ©s : ${found.length}/${keywords.length}`;
            msg.style.color = "#1f4f65";

            document.getElementById("next-btn").disabled = true;
            setTimeout(next, 2500);
        };
    }

    // â”€â”€ TEXTE (ancien format) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    else if(act.type==="texte"){
        container.innerHTML=`<h3>${act.question}</h3><div class="styled-input"><input type="text" id="text-answer" placeholder="RÃ©ponse"></div><button id="next-btn" class="btn btn-primary">Suivant</button>`;
        document.getElementById("next-btn").onclick=()=>{
            const answer=document.getElementById("text-answer").value.trim();
            if(answer===""){ alert("Ã‰cris ta rÃ©ponse"); return; }
            if(answer===act.correctAnswer){ totalScore+=20; showFloatingScore("+20","#4CAF50"); }
            else{ showFloatingScore("-10","#f44336"); }
            updateScoreBadge();
            setTimeout(next,1200);
        };
    }

    // â”€â”€ DRAGDROP (ancien format) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    else if(act.type==="dragdrop"){
        const countries=Object.keys(act.options);
        const capitals=Object.values(act.options);
        container.innerHTML=`<h3>${act.question}</h3>
            <div class="drag-items">${countries.map(c=>`<div class="drag-item" draggable="true" data-capital="${act.options[c]}">${c}</div>`).join("")}</div>
            <div class="drop-zones">${capitals.map(cap=>`<div class="drop-zone" data-correct="${cap}">${cap}</div>`).join("")}</div>
            <button id="next-btn" class="btn btn-primary">Suivant</button>`;
        initDragDrop();
        document.getElementById("next-btn").onclick=next;
    }

    // â”€â”€ MEMORY (ancien format) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    else if(act.type==="memory"){
        container.innerHTML=`<h3>${act.question}</h3><div class="memory-board" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;"></div><div style="margin-top:15px;">Score: <span id="memory-score">0</span></div><button id="next-btn" class="btn btn-primary" style="margin-top:20px;">Suivant</button>`;
        initMemory();
        document.getElementById("next-btn").onclick=next;
    }

    // â”€â”€ PUZZLE (ancien format) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    else if(act.type==="puzzle"){
        let correct=[...act.options]; let cur=[...correct].sort(()=>Math.random()-0.5);
        container.innerHTML=`<h3>${act.question}</h3><ul id="puzzle-list" style="list-style:none;padding:0;"></ul><button id="check-btn" class="btn btn-success">Valider</button><div id="puzzle-msg" style="margin-top:15px;font-weight:bold"></div>`;
        const list=document.getElementById("puzzle-list"); const msg=document.getElementById("puzzle-msg");
        function draw(){ list.innerHTML=""; cur.forEach((text,i)=>{
            const li=document.createElement("li"); li.textContent=text; li.draggable=true;
            Object.assign(li.style,{padding:"12px",margin:"8px 0",background:"#eef2ff",borderRadius:"12px",cursor:"grab",fontWeight:"500",transition:"0.25s",boxShadow:"0 2px 6px rgba(0,0,0,0.1)"});
            li.addEventListener("dragstart",e=>{ e.dataTransfer.setData("index",i); li.style.opacity="0.4"; });
            li.addEventListener("dragend",()=>{ li.style.opacity="1"; });
            li.addEventListener("dragover",e=>e.preventDefault());
            li.addEventListener("drop",e=>{ e.preventDefault(); const from=e.dataTransfer.getData("index"); [cur[from],cur[i]]=[cur[i],cur[from]]; draw(); });
            list.appendChild(li);
        }); }
        draw();
        document.getElementById("check-btn").onclick=()=>{
            let good=0; cur.forEach((v,i)=>{ if(v===correct[i]) good++; });
            let percent=Math.round((good/correct.length)*100);
            totalScore+=percent;
            showFloatingScore("+"+percent,"#4CAF50");
            updateScoreBadge();
            if(percent===100){ msg.textContent="âœ… Parfait !"; msg.style.color="green"; }
            else if(percent>=50){ msg.textContent="ğŸ™‚ Presque !"; msg.style.color="orange"; }
            else{ msg.textContent="âŒ Incorrect"; msg.style.color="red"; }
            setTimeout(next,1200);
        };
    }

    // â”€â”€ Type inconnu â†’ passer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    else { next(); }
}

// ================= NEXT =================
function next(){ current++; if(current<activities.length){ renderActivity(current); }else{ sendChallengeResult(); } }

// ================= SHOW VICTORY =================
function showVictory() {
    const win = document.createElement("div");
    Object.assign(win.style, {
        position: "fixed", inset: "0", background: "rgba(0,0,0,0.95)",
        display: "flex", alignItems: "center", justifyContent: "center",
        flexDirection: "column", color: "#fff", fontSize: "3rem",
        zIndex: "10000", animation: "fadeIn 0.5s"
    });

    const badgesList = [
        { score: 20, text: "ğŸ¥‰ Novice" },
        { score: 40, text: "ğŸ¥ˆ Apprenti" },
        { score: 60, text: "ğŸ¥‡ CompÃ©tent" },
        { score: 80, text: "ğŸ† Expert" },
    ];
    let awardedBadge = badgesList[0].text;
    for (let i = 0; i < badgesList.length; i++) {
        if (totalScore >= badgesList[i].score) awardedBadge = badgesList[i].text;
    }

    win.innerHTML = `
        <div>ğŸ† Victoire !</div>
        <div style="font-size:1.5rem; margin-top:20px">Score : ${Math.round(totalScore)}%</div>
        <div style="font-size:1.5rem; margin-top:10px">${awardedBadge}</div>
        <div style="margin-top:40px; display:flex; gap:20px; flex-wrap:wrap;">
            <button id="btn-exam" style="padding:10px 25px; font-size:1rem; border-radius:12px; border:none; background:#4CAF50; color:#fff; cursor:pointer;">Passer Ã  l'examen</button>
            <button id="btn-leaderboard" style="padding:10px 25px; font-size:1rem; border-radius:12px; border:none; background:#2196F3; color:#fff; cursor:pointer;">Voir le leaderboard</button>
        </div>
    `;
    document.body.appendChild(win);

    document.getElementById("btn-exam").onclick = () => {
        window.location.href = `/examen/${Math.round(totalScore)>=50 ? 'moyen' : 'facile'}`;
    };
    document.getElementById("btn-leaderboard").onclick = () => {
        window.location.href = "{{ path('leaderboard') }}";
    };
}

// ================= SEND RESULT =================
function sendChallengeResult(){
    if(finished) return; finished=true;
    const zones=document.querySelectorAll('.drop-zone');
    let reponses=[]; zones.forEach(z=>{ reponses.push(z.dataset.value||null); });
    let percent=Math.round(totalScore); if(percent>100) percent=100;
    let niveau = percent>=80 ? "difficile" : percent>=50 ? "moyen" : "facile";
    document.getElementById("last-score").textContent=percent+"%";
    document.getElementById("last-niveau").textContent=niveau;
    showVictory();
    fetch('/challenge/{{ challenge.id }}/update-score',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({score:percent,niveau:niveau,reponses:reponses})
    }).then(r=>r.json()).then(data=>{ if(data.status==="success"){ window.location.href=`/examen/${niveau}`; } else{ alert("Erreur sauvegarde score"); } });
}

// ================= START =================
renderActivity(current);

</script>

<style>
@keyframes shake{0%{transform:translateX(0);}20%{transform:translateX(-5px);}40%{transform:translateX(5px);}60%{transform:translateX(-5px);}80%{transform:translateX(5px);}100%{transform:translateX(0);}}
@keyframes fadeIn{0%{opacity:0;}100%{opacity:1;}}
.card{transition:transform 0.5s; transform-style: preserve-3d;}
.card.flipped{transform: rotateY(180deg);}
.card-front,.card-back{position:absolute; backface-visibility:hidden; display:flex; align-items:center; justify-content:center; width:100%; height:100%;}
.card-back{transform:rotateY(180deg);}
.styled-option{margin:8px 0;}
.styled-option input[type="radio"]{display:none;}
.styled-option label{display:block; padding:10px 15px; border-radius:12px; background:#eef2ff; cursor:pointer; font-weight:600; transition:0.3s; border:2px solid #1f4f65;}
.styled-option input[type="radio"]:checked + label{background:#4CAF50;color:#fff; border-color:#4CAF50;}
.styled-input input{width:100%;padding:10px 15px;border-radius:12px;border:2px solid #1f4f65;font-size:1rem;transition:0.3s;}
.styled-input input:focus{outline:none;border-color:#4CAF50; box-shadow:0 0 8px #4CAF50;}
</style>
{% endblock %}
